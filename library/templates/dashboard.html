{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<!-- Full screen section -->
<div id="dashboard-section" style="min-height: 100vh; width: 100%; padding: 60px 40px; background: #f5f7fa; box-sizing: border-box;">
    <div class="container-fluid">
        <h2 class="mb-5 text-primary fw-bold display-5 text-center">ðŸ“š Library Dashboard</h2>

        <div class="row g-4">
            <!-- Top Authors Chart -->
            <div class="col-xl-6 col-lg-12">
                <div class="card shadow-sm border-0 rounded-4 hover-scale bg-gradient-author text-white h-100">
                    <div class="card-header fw-semibold fs-5">
                        Top Authors
                    </div>
                    <div class="card-body d-flex align-items-center justify-content-center">
                        <canvas id="authorsChart" height="200"></canvas>
                    </div>
                </div>
            </div>

            <!-- Books by Genre Chart -->
            <div class="col-xl-6 col-lg-12">
                <div class="card shadow-sm border-0 rounded-4 hover-scale bg-gradient-genre text-white h-100">
                    <div class="card-header fw-semibold fs-5">
                        Books by Genre
                    </div>
                    <div class="card-body d-flex align-items-center justify-content-center">
                        <canvas id="genresChart" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="text-center mt-5">
            <button id="refreshCharts" class="btn btn-outline-primary btn-lg">ðŸ”„ Refresh Charts</button>
        </div>
    </div>
</div>

<style>
/* Full screen hover effect */
.hover-scale:hover {
    transform: scale(1.03);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    box-shadow: 0 12px 25px rgba(0,0,0,0.25);
}

/* Card gradients */
.bg-gradient-author {
    background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
}

.bg-gradient-genre {
    background: linear-gradient(135deg, #ff7e5f 0%, #feb47b 100%);
}

/* Smooth chart fade-in */
canvas {
    opacity: 0;
    animation: fadeIn 1s forwards;
}

@keyframes fadeIn {
    to { opacity: 1; }
}

/* Refresh button hover */
#refreshCharts:hover {
    transform: scale(1.05);
    transition: transform 0.2s ease;
}

/* Make sure the body and html take full height */
html, body {
    height: 100%;
    margin: 0;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
function generateColors(count) {
    const colors = [];
    for(let i=0; i<count; i++){
        colors.push(`hsl(${Math.floor(360 * Math.random())}, 65%, 55%)`);
    }
    return colors;
}

// Chart instances
let authorsChartInstance, genresChartInstance;

function renderCharts() {
    // Authors Chart
    fetch("{% url 'api_top_authors' %}")
    .then(res => res.json())
    .then(data => {
        const ctx = document.getElementById("authorsChart").getContext("2d");
        if(authorsChartInstance) authorsChartInstance.destroy();
        authorsChartInstance = new Chart(ctx, {
            type: "bar",
            data: {
                labels: data.labels,
                datasets: [{
                    label: "Books Count",
                    data: data.counts,
                    backgroundColor: generateColors(data.labels.length),
                    borderColor: "#333",
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: true, position: 'top', labels: { color: "#fff", font: { weight: '600' } } },
                    tooltip: { enabled: true, mode: 'index', intersect: false, backgroundColor: 'rgba(0,0,0,0.8)', titleColor: '#fff', bodyColor: '#fff' }
                },
                scales: {
                    y: { beginAtZero: true, ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.2)' } },
                    x: { ticks: { color: '#fff' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                },
                animation: { duration: 1200, easing: 'easeOutQuart' }
            }
        });
    });

    // Genres Chart
    fetch("{% url 'api_books_by_genre' %}")
    .then(res => res.json())
    .then(data => {
        const ctx = document.getElementById("genresChart").getContext("2d");
        if(genresChartInstance) genresChartInstance.destroy();
        genresChartInstance = new Chart(ctx, {
            type: "doughnut",
            data: {
                labels: data.labels,
                datasets: [{
                    label: "Books Count",
                    data: data.counts,
                    backgroundColor: generateColors(data.labels.length),
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: true, position: 'right', labels: { color: "#fff", boxWidth: 20, font: { weight: '500' } } },
                    tooltip: { enabled: true, backgroundColor: 'rgba(0,0,0,0.8)', titleColor: '#fff', bodyColor: '#fff' }
                },
                animation: { duration: 1400, easing: 'easeOutBounce' }
            }
        });
    });
}

// Initial render
renderCharts();

// Refresh button
document.getElementById("refreshCharts").addEventListener("click", renderCharts);
</script>
{% endblock %}
